<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UTS Alpro – Fetch Endpoint → Tabel Interaktif</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.datatables.net/v/bs5/dt-2.1.6/datatables.min.css" rel="stylesheet" />
  <style>
    body { background: #0f172a; color: #e2e8f0; }
    .card { background: #111827; border: 1px solid #1f2937; }
    .form-control, .form-select { background: #0b1220; color: #e5e7eb; border-color: #334155; }
    .form-control::placeholder { color: #94a3b8; }
    .btn-primary { background: #2563eb; border-color: #2563eb; }
    .btn-secondary { background: #374151; border-color: #4b5563; }
    .dt-container .dt-input { color: #111827 !important; }
    .table thead th { white-space: nowrap; }
    .spinner-border{ --bs-spinner-border-color:#60a5fa; --bs-spinner-animation-speed:0.65s; }
    a, a:visited { color:#93c5fd; }
    .smallcode{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace; }
  </style>
</head>
<body>
<div class="container py-4">
  <h1 class="h3 mb-3">UTS Alpro – Web Client Endpoint → Tabel Interaktif</h1>
  <p class="mb-4">Masukkan URL endpoint (GET) lalu klik <strong>Submit</strong>. Halaman akan menampilkan data dalam tabel yang bisa <em>search</em> dan <em>sort</em>. Contoh endpoint lokal: <span class="smallcode">http://localhost/UTS_Alpro_Endpoint_Table_with_proxy/alpro.json</span></p>

  <div class="card mb-4">
    <div class="card-body">
      <form id="fetchForm" class="row g-2 align-items-end">
        <div class="col-12 col-md-9">
          <label for="endpoint" class="form-label">Endpoint URL</label>
          <input type="text" class="form-control" id="endpoint" placeholder="http://localhost/UTS_Alpro_Endpoint_Table_with_proxy/alpro.json" required />
        </div>
        <div class="col-6 col-md-2">
          <button type="submit" class="btn btn-primary w-100" id="submitBtn">Submit</button>
        </div>
        <div class="col-6 col-md-1 text-center">
          <button type="button" class="btn btn-secondary w-100" id="demoBtn" title="Gunakan data demo jika server down">Demo</button>
        </div>
      </form>
      <div id="hint" class="form-text mt-2">Jika request lintas-origin diblokir (CORS), halaman akan otomatis mencoba via <span class="smallcode">proxy.php</span> (server XAMPP kamu).</div>
    </div>
  </div>

  <div id="statusArea" class="mb-3" role="alert"></div>

  <div class="card" id="tableCard" style="display:none;">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="h5 mb-0">Hasil</h2>
        <div class="small" id="meta"></div>
      </div>
      <div class="table-responsive">
        <table id="dataTable" class="table table-striped table-hover table-borderless w-100"></table>
      </div>
    </div>
  </div>

  <footer class="mt-4 small text-secondary">Tabel interaktif by DataTables; kolom otomatis + nomor urut; fallback proxy.php untuk CORS.</footer>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/v/bs5/dt-2.1.6/datatables.min.js"></script>
<script>
(async function(){
  const form        = document.getElementById('fetchForm');
  const endpointInp = document.getElementById('endpoint');
  const statusArea  = document.getElementById('statusArea');
  const tableCard   = document.getElementById('tableCard');
  const meta        = document.getElementById('meta');
  const submitBtn   = document.getElementById('submitBtn');
  const demoBtn     = document.getElementById('demoBtn');

  let dt = null; // DataTable instance

  // UI helpers
  const setStatus = (html, type='info') => {
    const cls = {info:'alert alert-info',success:'alert alert-success',danger:'alert alert-danger',warning:'alert alert-warning'}[type]||'alert alert-secondary';
    statusArea.className = cls; statusArea.innerHTML = html;
  };
  const clearStatus = () => { statusArea.className=''; statusArea.innerHTML=''; };
  const startLoading = () => { submitBtn.disabled=true; submitBtn.innerHTML='<span class="spinner-border spinner-border-sm"></span> Loading…'; };
  const stopLoading  = () => { submitBtn.disabled=false; submitBtn.textContent='Submit'; };

  // Normalisasi data
  function normalize(raw){
    if (raw == null) return [];
    if (Array.isArray(raw)) return raw;
    if (typeof raw === 'object'){
      if (Array.isArray(raw.data))    return raw.data;
      if (Array.isArray(raw.results)) return raw.results;
      return Object.values(raw);
    }
    return [];
  }

  // Kolom otomatis: No + semua key unik
  function buildColumns(rows){
    const keys = new Set();
    rows.forEach(r => Object.keys(r||{}).forEach(k => keys.add(k)));
    keys.delete('No'); // hindari dobel jika sumber punya 'No'
    const ordered = ['No', ...Array.from(keys).sort()];
    return ordered.map(k => ({ title:k, data:k==='No'?null:k, defaultContent:'' }));
  }
  const withIndex = (rows) => rows.map((r,i) => ({ No:i+1, ...(r||{}) }));

  // Render tabel
  function renderTable(rows){
    const data    = withIndex(rows);
    const columns = buildColumns(data);
    const table   = $('#dataTable');

    if (dt){ dt.destroy(); table.empty(); }

    dt = table.DataTable({
      data, columns,
      paging:true, pageLength:10, responsive:true,
      ordering:true, searching:true,
      order:[[0,'asc']],
      columnDefs:[{targets:0, orderable:true}],
      language:{
        search:'Cari:', lengthMenu:'Tampilkan _MENU_ entri',
        info:'Menampilkan _START_ sampai _END_ dari _TOTAL_ entri',
        infoFiltered:'(disaring dari _MAX_ entri keseluruhan)',
        paginate:{previous:'Sebelumnya', next:'Selanjutnya'}
      }
    });

    const builtInSearch = document.querySelector('.dt-search input');
    if (builtInSearch){
      builtInSearch.setAttribute('placeholder','Ketik untuk mencari…');
      builtInSearch.classList.add('form-control');
    }

    tableCard.style.display = 'block';
    setStatus('Sukses memuat ' + data.length + ' baris.', 'success');
  }

  // Fetch helper
  async function tryFetch(url){
    const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
    if(!res.ok) throw new Error('HTTP ' + res.status + ' – ' + res.statusText);
    return res.json();
  }
  async function fetchAndRender(url){
    clearStatus(); startLoading();
    try{
      let raw;
      try { raw = await tryFetch(url); }
      catch { raw = await tryFetch('proxy.php?url=' + encodeURIComponent(url));
              setStatus('Direct fetch diblokir, menggunakan <code>proxy.php</code>.', 'info'); }
      const rows = normalize(raw);
      if (!rows.length){ setStatus('Request OK tapi data kosong/tidak terdeteksi.', 'warning'); tableCard.style.display='none'; return; }
      renderTable(rows); meta.textContent = 'Sumber: ' + url;
    } catch(err){
      console.error(err); setStatus('Gagal memuat: ' + err.message, 'danger'); tableCard.style.display='none';
    } finally { stopLoading(); }
  }

  form.addEventListener('submit', e => {
    e.preventDefault();
    const url = endpointInp.value.trim();
    if (!url){ setStatus('Harap isi URL endpoint.', 'warning'); return; }
    fetchAndRender(url);
  });

  demoBtn.addEventListener('click', () => {
    const demo = [
      { program_studi:'Rekayasa Nanoteknologi', jenjang:'S1', akreditasi:'BA' },
      { program_studi:'Teknik Elektro', jenjang:'S1', akreditasi:'BA' },
      { program_studi:'Teknik Industri', jenjang:'S1', akreditasi:'BA' },
      { program_studi:'Teknik Robotika Dan Kecerdasan Buatan', jenjang:'S1', akreditasi:'BA' },
      { program_studi:'Teknologi Sains Data', jenjang:'S1', akreditasi:'BA' }
    ];
    renderTable(demo);
    meta.textContent = 'Sumber: data demo lokal';
  });

  // Default: endpoint lokal supaya langsung jalan
  endpointInp.value = 'http://localhost/UTS_Alpro_Endpoint_Table_with_proxy/alpro.json';
})();
</script>
</body>
</html>
